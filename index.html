<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Plan Builder</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 2rem;
    }
    .card {
      max-width: 900px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
    }
    h1, h2 { margin-top: 0; }
    input, textarea, button {
      width: 100%;
      margin: 0.5rem 0 1rem;
      padding: 0.75rem;
      font-size: 1rem;
    }
    button {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111;
    }
    .hidden { display: none; }
    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<div class="card" id="login">
  <h1>Business Plan Builder</h1>
  <input id="studentName" placeholder="Student name" />
  <input id="studentSection" placeholder="Section / Class" />
  <button onclick="start()">Start / Continue</button>
  <div id="loginMsg"></div>
</div>

<div class="card hidden" id="editor">
  <h2>Business Info</h2>
  <input id="cafeName" placeholder="Cafe name" />
  <textarea id="mission" placeholder="Mission"></textarea>
  <textarea id="briefDesc" placeholder="Brief description"></textarea>
  <textarea id="mainGoal" placeholder="Main goal"></textarea>

  <button class="secondary" onclick="save()">Save Draft</button>
  <button onclick="submitPlan()">Submit Business Plan</button>

  <div id="errorBox" class="error hidden"></div>
</div>

<script>
const APPS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbxq1lNGPH-yyWA25C8oPysSXUyOcSq27AXEuI7Z_V9vf4bXQYiWzePrEjgQzz3xGXvDUQ/exec";

let studentId = "";
let businessPlan = {};

function show(id) {
  document.getElementById("login").classList.add("hidden");
  document.getElementById("editor").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

async function apiGet(params) {
  const url = new URL(APPS_SCRIPT_URL);
  Object.entries(params).forEach(([k, v]) =>
    url.searchParams.set(k, v ?? "")
  );
  const res = await fetch(url.toString());
  return await res.json();
}

async function apiPost(params) {
  const body = new URLSearchParams();
  Object.entries(params).forEach(([k, v]) =>
    body.set(k, v ?? "")
  );
  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
    },
    body: body.toString()
  });
  return await res.json();
}

async function start() {
  const name = studentName.value.trim();
  const section = studentSection.value.trim();
  if (!name || !section) return;

  studentId = `${name}-${section}`.toLowerCase().replace(/\s+/g, "_");

  const result = await apiGet({
    action: "load",
    studentId,
    studentName: name
  });

  if (result.success && result.found) {
    businessPlan = JSON.parse(result.data);
  } else {
    businessPlan = {
      studentName: name,
      studentSection: section,
      status: "draft"
    };
  }

  cafeName.value = businessPlan.cafeName || "";
  mission.value = businessPlan.mission || "";
  briefDesc.value = businessPlan.briefDesc || "";
  mainGoal.value = businessPlan.mainGoal || "";

  show("editor");
}

async function save() {
  businessPlan.cafeName = cafeName.value;
  businessPlan.mission = mission.value;
  businessPlan.briefDesc = briefDesc.value;
  businessPlan.mainGoal = mainGoal.value;

  await apiPost({
    action: "save",
    studentId,
    studentName: businessPlan.studentName,
    data: JSON.stringify(businessPlan)
  });
}

async function submitPlan() {
  try {
    businessPlan.cafeName = cafeName.value;
    businessPlan.mission = mission.value;
    businessPlan.briefDesc = briefDesc.value;
    businessPlan.mainGoal = mainGoal.value;

    const result = await apiPost({
      action: "submit",
      studentId,
      studentName: businessPlan.studentName,
      cafeName: businessPlan.cafeName,
      mission: businessPlan.mission,
      briefDesc: businessPlan.briefDesc,
      mainGoal: businessPlan.mainGoal
    });

    if (!result.success) throw new Error(result.error);
    alert("Submitted successfully!");
  } catch (err) {
    errorBox.textContent = err.message;
    errorBox.classList.remove("hidden");
  }
}
</script>

</body>
</html>

